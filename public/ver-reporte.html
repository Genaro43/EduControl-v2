<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Ver reportes — EduControl</title>
    <link rel="stylesheet" href="../build/css/app.css" />
</head>

<body class="app">
    <header class="app__header" role="banner">
        <div class="logo" aria-hidden="true">logo</div>
    </header>

    <main class="app__main pagina-reportes" role="main">
        <section class="perfil">
            <h1 class="nombre-alumno">Genaro Rosales Carrasco</h1>

            <div class="perfil-contenedor">
                <div class="perfil-info">
                    <div class="campo-info"><strong>Semestre</strong> <span>5</span></div>
                    <div class="campo-info"><strong>Grupo</strong> <span>j</span></div>
                    <div class="campo-info"><strong>Matrícula</strong> <span class="matricula">20211234</span></div>
                </div>

                <div class="perfil-foto">
                    <div class="foto-tarjeta">
                        <img src="../src/img/122171.jpg" alt="Foto del alumno" />
                    </div>
                </div>
            </div>
        </section>

        <section id="lista-reportes" class="lista-reportes" aria-live="polite"></section>

        <div class="acciones-final">
            <a class="btn boton-salir" id="btn-regresar" href="alumnos-vista.html">regresar</a>
        </div>
    </main>

    <script>
        (function () {
            const STORAGE_KEY = 'edu_reportes';
            const $lista = document.getElementById('lista-reportes');

            // Leer raw
            function leerRaw() {
                try {
                    const s = localStorage.getItem(STORAGE_KEY);
                    console.debug('leerRaw -> localStorage.' + STORAGE_KEY + ':', s);
                    return s ? JSON.parse(s) : null;
                } catch (e) {
                    console.warn('leerRaw: JSON parse error', e);
                    return null;
                }
            }

            // Normalizar
            function normalizar(r, fallbackId) {
                return {
                    id: String(r && (r.id || r._id) ? (r.id || r._id) : (fallbackId || ('r' + Date.now() + Math.floor(Math.random() * 10000)))),
                    matricula: String((r && (r.matricula || r.matr || r.matric)) || '').trim(),
                    tipo: (r && r.tipo) || 'reporte',
                    descripcion: (r && r.descripcion) || '',
                    horas: Number((r && (typeof r.horas !== 'undefined' ? r.horas : r.hours)) || 0),
                    aplicadoPor: (r && (r.aplicadoPor || r.aplicador)) || '',
                    ultimaMod: (r && (r.ultimaMod || r.updatedBy)) || '',
                    createdAt: (r && r.createdAt) || new Date().toISOString(),
                    updatedAt: (r && r.updatedAt) || new Date().toISOString()
                };
            }

            // Normalizar todo
            function leerReportesNormalizados() {
                const raw = leerRaw();
                if (!raw) return [];
                if (Array.isArray(raw)) {
                    return raw.map((r, i) => normalizar(r, r && r.id ? r.id : ('a' + i)));
                }
                if (typeof raw === 'object') {
                    return Object.keys(raw).map(k => {
                        const v = raw[k];
                        if (typeof v === 'number') return normalizar({ id: k, horas: v }, k);
                        if (typeof v === 'object') {
                            const clone = Object.assign({}, v);
                            if (!clone.id) clone.id = k;
                            return normalizar(clone, k);
                        }
                        return normalizar({ id: k }, k);
                    });
                }
                return [];
            }

            // Guardar reporte (obj keyed)
            function guardarReporteCompleto(report) {
                const raw = leerRaw();
                let obj = {};
                if (raw && typeof raw === 'object' && !Array.isArray(raw)) obj = Object.assign({}, raw);
                if (Array.isArray(raw)) {
                    raw.forEach(item => {
                        const nr = normalizar(item);
                        obj[nr.id] = nr;
                    });
                }
                obj[report.id] = report;
                localStorage.setItem(STORAGE_KEY, JSON.stringify(obj));
                console.debug('guardarReporteCompleto -> saved id=', report.id);
            }

            // Obtener matrícula objetivo: PRIORIDAD DOM (.matricula) -> si no existe usar ?matricula=
            function obtenerMatriculaObjetivo() {
                // Intentar DOM primero
                const el = document.querySelector('.matricula');
                if (el) {
                    const digits = (el.textContent || '').match(/\d+/);
                    if (digits) {
                        console.debug('obtenerMatriculaObjetivo -> usando DOM .matricula:', digits[0]);
                        return digits[0];
                    }
                }

                // Fallback: query param
                try {
                    const url = new URL(location.href);
                    const q = url.searchParams.get('matricula') || '';
                    if (q) {
                        const digits = (q + '').match(/\d+/);
                        if (digits) {
                            console.debug('obtenerMatriculaObjetivo -> usando query param:', digits[0]);
                            return digits[0];
                        }
                    }
                } catch (e) { /* ignore */ }

                console.debug('obtenerMatriculaObjetivo -> no matricula encontrada');
                return '';
            }

            // Comparar matriculas (solo dígitos)
            function matriculaIgual(a, b) {
                const an = (String(a || '')).match(/\d+/);
                const bn = (String(b || '')).match(/\d+/);
                if (!an || !bn) return false;
                return an[0] === bn[0];
            }

            function esc(s) { return String(s || ''); }

            function crearTarjeta(report) {
                const horas = Number(report.horas || 0);
                const art = document.createElement('article');
                art.className = 'reporte-card ' + (horas > 0 ? 'adeuda' : 'pagado');
                art.dataset.id = report.id;
                art.dataset.horas = String(horas);
                art.dataset.matricula = String(report.matricula || '');
                art.tabIndex = 0;

                const contenido = document.createElement('div');
                contenido.className = 'reporte-contenido';
                contenido.innerHTML = `
        <div class="reporte-tipo">${esc(report.tipo)}</div>
        <div class="reporte-meta">Aplicó: ${esc(report.aplicadoPor)} · Última modificación: ${esc(report.ultimaMod)}</div>
        <div class="reporte-horas">Horas adeudadas: <span class="horas-valor">${horas}</span></div>
        <div class="reporte-desc">${esc(report.descripcion)}</div>
      `;
                const controles = document.createElement('div');
                controles.className = 'reporte-controles';

                const btnUp = document.createElement('button');
                btnUp.className = 'btn flecha flecha-up';
                btnUp.type = 'button';
                btnUp.textContent = '▲';
                btnUp.setAttribute('disabled', '');

                const btnDown = document.createElement('button');
                btnDown.className = 'btn flecha flecha-down';
                btnDown.type = 'button';
                btnDown.textContent = '▼';
                btnDown.setAttribute('disabled', '');

                controles.appendChild(btnUp);
                controles.appendChild(btnDown);

                art.appendChild(contenido);
                art.appendChild(controles);
                art._report = report;
                return art;
            }

            // Mostrar logs con detalle de qué reportes fueron cargados y sus matrículas
            function debugListado(all) {
                console.group('DEBUG: listado de reportes normalizados');
                all.forEach(r => console.log('id=%s matricula=%s horas=%s tipo=%s', r.id, r.matricula, r.horas, r.tipo));
                console.groupEnd();
            }

            function render() {
                $lista.innerHTML = '';
                const all = leerReportesNormalizados();
                debugListado(all);

                const target = obtenerMatriculaObjetivo();
                const filtrados = target ? all.filter(r => matriculaIgual(r.matricula, target)) : all.slice();

                console.debug('render -> targetMat=', target, 'total=', all.length, 'filtrados=', filtrados.length);
                if (!filtrados.length) {
                    $lista.innerHTML = '<div style="padding:16px;color:#666;">No hay reportes para esta matrícula.</div>';
                    return;
                }

                filtrados.sort((a, b) => (Number(b.horas) || 0) - (Number(a.horas) || 0) || (new Date(b.createdAt) - new Date(a.createdAt)));

                filtrados.forEach(r => $lista.appendChild(crearTarjeta(r)));

                // asegurar flechas desactivadas
                document.querySelectorAll('.reporte-card').forEach(c => c.querySelectorAll('.flecha').forEach(f => f.setAttribute('disabled', '')));
            }

            // Edición (igual que antes)
            let tarjetaActiva = null;
            let horasTemp = 0;

            function setFlechas(tarjeta, activar) {
                tarjeta.querySelectorAll('.flecha').forEach(b => {
                    if (activar) b.removeAttribute('disabled'); else b.setAttribute('disabled', '');
                });
            }

            $lista.addEventListener('click', function (e) {
                const up = e.target.closest('.flecha-up');
                const down = e.target.closest('.flecha-down');

                if (up || down) {
                    const card = e.target.closest('.reporte-card');
                    if (!card || card !== tarjetaActiva) return;
                    horasTemp = up ? horasTemp + 1 : Math.max(0, horasTemp - 1);
                    const span = card.querySelector('.horas-valor'); if (span) span.textContent = String(horasTemp);
                    return;
                }

                const tarjeta = e.target.closest('.reporte-card');
                if (!tarjeta) return;
                if (!tarjeta.classList.contains('adeuda')) return;

                if (!tarjetaActiva) {
                    tarjetaActiva = tarjeta;
                    tarjetaActiva.classList.add('seleccionado');
                    horasTemp = Number(tarjetaActiva.dataset.horas || 0);
                    setFlechas(tarjetaActiva, true);
                    document.querySelectorAll('.reporte-card.seleccionado').forEach(c => { if (c !== tarjetaActiva) c.classList.remove('seleccionado'); });
                    return;
                }

                if (tarjetaActiva === tarjeta) {
                    const id = tarjetaActiva.dataset.id;
                    const all = leerReportesNormalizados();
                    let rep = all.find(r => String(r.id) === String(id)) || tarjetaActiva._report || { id, matricula: tarjetaActiva.dataset.matricula || '' };
                    rep.horas = Number(horasTemp);
                    rep.ultimaMod = sessionStorage.getItem('edu_user') || rep.ultimaMod || 'demo';
                    rep.updatedAt = new Date().toISOString();

                    guardarReporteCompleto(rep);

                    tarjetaActiva.dataset.horas = String(rep.horas);
                    const span = tarjetaActiva.querySelector('.horas-valor'); if (span) span.textContent = String(rep.horas);
                    if (rep.horas <= 0) { tarjetaActiva.classList.remove('adeuda'); tarjetaActiva.classList.add('pagado'); }
                    else { tarjetaActiva.classList.remove('pagado'); tarjetaActiva.classList.add('adeuda'); }

                    setFlechas(tarjetaActiva, false);
                    tarjetaActiva.classList.remove('seleccionado');
                    tarjetaActiva = null;
                    horasTemp = 0;

                    render();
                    return;
                }

                if (tarjetaActiva && tarjetaActiva !== tarjeta) {
                    const prev = tarjetaActiva;
                    const spanPrev = prev.querySelector('.horas-valor'); if (spanPrev) spanPrev.textContent = String(prev.dataset.horas || '0');
                    setFlechas(prev, false);
                    prev.classList.remove('seleccionado');

                    tarjetaActiva = tarjeta;
                    tarjetaActiva.classList.add('seleccionado');
                    horasTemp = Number(tarjetaActiva.dataset.horas || 0);
                    setFlechas(tarjetaActiva, true);
                    return;
                }
            });

            $lista.addEventListener('keydown', function (e) {
                const card = e.target.closest('.reporte-card'); if (!card) return;
                if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); card.click(); }
                if ((e.key === 'ArrowUp' || e.key === 'ArrowDown') && card === tarjetaActiva) {
                    e.preventDefault();
                    horasTemp = (e.key === 'ArrowUp') ? horasTemp + 1 : Math.max(0, horasTemp - 1);
                    const span = card.querySelector('.horas-valor'); if (span) span.textContent = String(horasTemp);
                }
            });

            window.addEventListener('storage', function (e) {
                if (e.key === STORAGE_KEY) {
                    console.debug('storage event detected -> re-render');
                    render();
                }
            });

            render();

            window.__edu_reportes_helpers = { leerRaw, leerReportesNormalizados, guardarReporteCompleto };
        })();
    </script>
</body>

</html>